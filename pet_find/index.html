<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 인공지능 판독기</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-5 font-sans">

    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="gradient-bg p-6 text-white text-center">
            <h1 class="text-2xl font-bold">AI 판독기</h1>
            <p class="text-sm opacity-80">티처블 머신 모델을 직접 실행해보세요</p>
        </div>

        <div class="p-6 space-y-4">
            <!-- 모델 URL 설정 부분 (학생들이 수정할 곳) -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <label class="block text-xs font-semibold text-blue-600 mb-1 uppercase">모델 링크 (URL)</label>
                <input type="text" id="model-url" 
                       placeholder="https://teachablemachine.withgoogle.com/models/..." 
                       class="w-full p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="init()" id="start-btn" class="w-full mt-2 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                    카메라 시작하기
                </button>
            </div>

            <!-- 화면 표시 영역 -->
            <div id="webcam-container" class="relative rounded-xl overflow-hidden bg-black aspect-video flex items-center justify-center">
                <div id="loading-text" class="text-white text-sm">카메라를 기다리는 중...</div>
            </div>

            <!-- 결과 표시 영역 -->
            <div id="label-container" class="space-y-2">
                <!-- 결과가 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 1. 학생들이 티처블 머신에서 '내보내기'한 모델 URL
        let model, webcam, labelContainer, maxPredictions;

        async function init() {
            const URL = document.getElementById('model-url').value;
            if (!URL) {
                alert("티처블 머신에서 생성한 모델 URL을 입력해주세요!");
                return;
            }

            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerText = "모델 로딩 중...";

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                // 모델 로드
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // 웹캠 설정
                const flip = true; 
                webcam = new tmImage.Webcam(400, 300, flip); 
                await webcam.setup(); 
                await webcam.play();
                window.requestAnimationFrame(loop);

                // 화면에 웹캠 추가
                document.getElementById('webcam-container').innerHTML = "";
                document.getElementById('webcam-container').appendChild(webcam.canvas);
                webcam.canvas.classList.add("w-full", "h-full", "object-cover");

                // 결과 바구니 생성
                labelContainer = document.getElementById("label-container");
                for (let i = 0; i < maxPredictions; i++) {
                    const barBg = document.createElement("div");
                    barBg.className = "w-full bg-gray-200 rounded-full h-4 relative overflow-hidden";
                    
                    const barFill = document.createElement("div");
                    barFill.id = "bar-" + i;
                    barFill.className = "bg-blue-500 h-full transition-all duration-200";
                    barFill.style.width = "0%";
                    
                    const labelText = document.createElement("div");
                    labelText.id = "text-" + i;
                    labelText.className = "flex justify-between text-xs font-bold mb-1 mt-2";
                    
                    labelContainer.appendChild(labelText);
                    barBg.appendChild(barFill);
                    labelContainer.appendChild(barBg);
                }
                
                document.getElementById('start-btn').innerText = "판독 중...";
            } catch (e) {
                alert("모델을 불러오지 못했습니다. URL을 다시 확인해주세요.");
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerText = "다시 시도";
            }
        }

        async function loop() {
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPath = prediction[i].className;
                const probability = (prediction[i].probability * 100).toFixed(0);
                
                document.getElementById("text-" + i).innerHTML = `<span>${classPath}</span><span>${probability}%</span>`;
                document.getElementById("bar-" + i).style.width = probability + "%";
            }
        }
    </script>
</body>
</html>